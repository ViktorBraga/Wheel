<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Spin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
            color: white;
            font-family: 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #roulette-window {
            position: relative;
            width: 320px;
            height: 420px;
            background: #050510;
            overflow: hidden;
            border-radius: 12px;
            border: 3px solid #00f7ff;
            box-shadow: 0 0 25px rgba(0, 247, 255, 0.4), inset 0 0 15px rgba(0, 247, 255, 0.2);
        }

        /* –ë–∏—Ä—é–∑–æ–≤—ã–µ –ø–æ–ª–æ—Å–∫–∏ –ø–æ –±–æ–∫–∞–º */
        #roulette-window::before, #roulette-window::after {
            content: '';
            position: absolute;
            top: 0;
            width: 3px;
            height: 100%;
            background: #00f7ff;
            box-shadow: 0 0 15px #00f7ff;
            z-index: 5;
        }
        #roulette-window::before { left: 0; }
        #roulette-window::after { right: 0; }

        #strip {
            position: absolute;
            top: -3000px; 
            left: 0;
            width: 100%;
            will-change: transform;
        }

        .card {
            height: 100px;
            width: 290px;
            margin: 12px auto; 
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            box-sizing: border-box;
            background: rgba(30, 30, 40, 0.8);
            color: #fff;
            font-weight: 800;
            font-size: 26px;
            text-transform: uppercase;
            border-left: 12px solid transparent;
            transform: skewX(-12deg);
            text-shadow: 0 0 8px rgba(255,255,255,0.3);
            transition: all 0.3s ease;
            position: relative;
        }

        .common { border-left-color: #2ecc71; }
        .rare { border-left-color: #3498db; }
        .epic { border-left-color: #9b59b6; }
        .legendary {
            border-left-color: #f1c40f;
            background: linear-gradient(90deg, rgba(241, 196, 15, 0.2) 0%, rgba(30, 30, 40, 0.8) 100%);
            color: #ffeaa7;
        }

        #selector-line {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            font-size: 60px;
            color: #8A2BE2;
            text-shadow: 0 0 30px #8A2BE2;
            z-index: 10;
            pointer-events: none;
        }

        #spinBtn {
            margin-top: 35px;
            padding: 20px 70px;
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
            font-style: italic;
            color: #fff;
            background: linear-gradient(45deg, #ff0055, #ff5e00);
            border: 2px solid #ff9db6;
            border-radius: 8px;
            transform: skewX(-12deg);
            cursor: pointer;
            box-shadow: 0 0 30px rgba(255, 0, 85, 0.6);
            transition: all 0.2s;
        }

        #spinBtn:active { transform: skewX(-12deg) translateY(3px); }
        #spinBtn:disabled { background: #444; border-color: #666; color: #888; box-shadow: none; }

        .balance-box { margin-bottom: 25px; font-size: 20px; color: #00f7ff; font-weight: bold; }
    </style>
</head>
<body>

    <div class="balance-box" id="bal-text">Points: 0</div>

    <div id="roulette-window">
        <div id="selector-line">‚óÑ</div>
        <div id="strip"></div>
    </div>

    <button id="spinBtn">–ö–†–£–¢–ò–¢–¨</button>

<script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- –ù–û–í–´–ô –ó–í–£–ö–û–í–û–ô –î–í–ò–ñ–û–ö (Web Audio API) ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let tickBuffer = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–≤—É–∫–∞ –≤ –ø–∞–º—è—Ç—å –æ–¥–∏–Ω —Ä–∞–∑
        async function loadTickSound() {
            try {
                const response = await fetch('click_wheel.mp3'); 
                const arrayBuffer = await response.arrayBuffer();
                tickBuffer = await audioCtx.decodeAudioData(arrayBuffer);
            } catch (e) { console.error("–ó–≤—É–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω:", e); }
        }
        loadTickSound();

        function playTick() {
            if (!tickBuffer) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const source = audioCtx.createBufferSource();
            source.buffer = tickBuffer;
            source.connect(audioCtx.destination);
            source.start(0);
        }

        const urlParams = new URLSearchParams(window.location.search);
        let userPoints = parseInt(urlParams.get('points')) || 0;
        document.getElementById('bal-text').innerText = "Points: " + userPoints;

        const possiblePrizes = [
            { t: "50 Points", type: "common", v: 50 },
            { t: "100 Points", type: "common", v: 100 },
            { t: "0 Points", type: "common", v: 0 },
            { t: "200 Points", type: "rare", v: 200 },
            { t: "250 Points", type: "rare", v: 250 },
            { t: "500 Points", type: "epic", v: 500 },
            { t: "JACKPOT", type: "legendary", v: "jackpot" }
        ];

        const strip = document.getElementById('strip');
        const btn = document.getElementById('spinBtn');
        const cardHeight = 112; 
        const cardsCount = 200; 
        const initialOffset = 3000;

        function initStrip() {
            let html = '';
            for (let i = 0; i < cardsCount; i++) {
                let randomPrize = possiblePrizes[Math.floor(Math.random() * possiblePrizes.length)];
                html += '<div class="card ' + randomPrize.type + '"><span>' + randomPrize.t + '</span><span>‚≠êÔ∏è</span></div>';
            }
            strip.innerHTML = html;
        }
        initStrip();

        if (userPoints < 100) {
            btn.disabled = true;
            btn.innerText = "NO POINTS";
        }

        btn.onclick = function() {
            // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞—É–¥–∏–æ-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫–ª–∏–∫–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤)
            if (audioCtx.state === 'suspended') audioCtx.resume();
            btn.disabled = true;

            var rand = Math.random() * 100;
            var winIndex;

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∞–Ω—Å–æ–≤
                    // –ù–û–í–ê–Ø –ñ–ï–°–¢–ö–ê–Ø –õ–û–ì–ò–ö–ê –®–ê–ù–°–û–í
        if (rand < 75) { 
            // 75% —à–∞–Ω—Å –Ω–∞ "–ë–∞–∑—É" (0, 50, 100)
            // –ò–≥—Ä–æ–∫ —á–∞—â–µ –≤—Å–µ–≥–æ –±—É–¥–µ—Ç –ª–∏–±–æ —Å–ª–∏–≤–∞—Ç—å, –ª–∏–±–æ –∫—Ä—É—Ç–∏—Ç—å –≤ –Ω–æ–ª—å
            var subRand = Math.random();
            if (subRand < 0.5) winIndex = 2;      // 0 CR (–ø–æ–ª–æ–≤–∏–Ω–∞ –∏–∑ –±–∞–∑—ã)
            else if (subRand < 0.8) winIndex = 0; // 50 CR
            else winIndex = 1;                    // 100 CR
        } 
        else if (rand < 98.5) { 
            // 23.5% —à–∞–Ω—Å –Ω–∞ —Å—Ä–µ–¥–Ω–∏–µ –ø—Ä–∏–∑—ã (200-250)
            winIndex = (Math.random() > 0.5) ? 3 : 4;
        } 
        else if (rand < 97.8) { 
            // –í–°–ï–ì–û 1% –®–ê–ù–° –Ω–∞ 500 CR (–±—ã–ª 14.5%)
            // –¢–µ–ø–µ—Ä—å 500 –≤—ã–ø–∞–¥–∞–µ—Ç —Ä–∞–∑ –≤ 100 –∏–≥—Ä
            winIndex = 5;
        } 
        else {
            // 0.5% –®–ê–ù–° –Ω–∞ JACKPOT
            winIndex = 6;
        }


            var finalPrizeObj = possiblePrizes[winIndex];
            var targetWinIdx = 75; 
            var allCards = strip.children;
            allCards[targetWinIdx].className = "card " + finalPrizeObj.type;
            var icon = (finalPrizeObj.type === 'legendary') ? 'üèÜ' : '‚≠êÔ∏è';
            allCards[targetWinIdx].innerHTML = "<span>" + finalPrizeObj.t + "</span><span>" + icon + "</span>";

            var windowHeight = 420;
            var targetPosition = (targetWinIdx * cardHeight) - initialOffset - (windowHeight / 2) + (cardHeight / 2);

            strip.style.transition = "transform 9s cubic-bezier(0.1, 0, 0.05, 1)";
            strip.style.transform = "translateY(-" + targetPosition + "px)";

            var lastCardIndex = 0;
            function trackSound() {
                var style = window.getComputedStyle(strip);
                var matrix = new WebKitCSSMatrix(style.transform);
                var currentY = Math.abs(matrix.m42);

                var absolutePositionOnStrip = currentY + initialOffset + (windowHeight / 2);
                var currentCardIdx = Math.floor(absolutePositionOnStrip / cardHeight);

                if (currentCardIdx > lastCardIndex && currentCardIdx < cardsCount) {
                    playTick(); // –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –∑–≤—É–∫ –∏–∑ –±—É—Ñ–µ—Ä–∞
                    if (tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
                    lastCardIndex = currentCardIdx;
                }

                if (currentY < targetPosition - 2) {
                    requestAnimationFrame(trackSound);
                } else {
                    setTimeout(function() {
                        allCards[targetWinIdx].style.transition = "all 0.3s";
                        allCards[targetWinIdx].style.background = "#fff";
                        allCards[targetWinIdx].style.color = "#000";
                        allCards[targetWinIdx].style.boxShadow = "0 0 60px #fff";
                        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');

                        setTimeout(function() { 
                            tg.sendData(JSON.stringify({ "action": "wheel_spin", "win": finalPrizeObj.v }));
                            setTimeout(() => tg.close(), 100);
                        }, 1000);
                    }, 300); 
                }
            }
            requestAnimationFrame(trackSound);
        };
    </script>
</body>

</html>





